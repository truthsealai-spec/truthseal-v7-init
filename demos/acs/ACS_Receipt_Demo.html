<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TruthSeal — Local ACS + Receipt Demo (Offline)</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0f14; color:#e6eef7; }
    .wrap { max-width: 920px; margin: 28px auto; padding: 0 16px; }
    h1 { font-size: 22px; margin: 0 0 12px; }
    .muted { color:#9ab; font-size:13px; }
    .card { background:#101820; border:1px solid #223344; border-radius:14px; padding:16px; margin:14px 0; }
    label { display:block; font-size:13px; color:#9ab; margin:8px 0 4px; }
    input[type="number"] { width: 140px; padding:8px 10px; border-radius:10px; border:1px solid #2a3b4f; background:#0f151c; color:#fff; }
    .row { display:flex; flex-wrap:wrap; gap:14px 24px; align-items:flex-end; }
    .pill { display:inline-block; padding:5px 10px; border-radius:999px; background:#0f2432; border:1px solid #234; font-size:12px; color:#cfe7ff; margin-right:8px; }
    .pill.good { background:#0a2a1a; border-color:#1e4; color:#bfffd1; }
    .pill.bad  { background:#2a0a0a; border-color:#e44; color:#ffc9c9; }
    .btn { cursor:pointer; padding:10px 14px; border-radius:12px; border:1px solid #2a3b4f; background:#123; color:#e6eef7; font-weight:600; }
    .btn:hover { filter: brightness(1.15); }
    .btn.primary { background:#0b3d91; }
    .btn.warn { background:#6b1a1a; }
    pre { background:#0c131a; border:1px solid #1f2d3a; border-radius:12px; padding:12px; overflow:auto; font-size:12px; }
    .kpi { font-size:44px; font-weight:800; letter-spacing:-0.02em; }
    .ok  { color:#86f7a6; }
    .bad { color:#ffb3b3; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .hint { font-size:12px; color:#9ab; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>TruthSeal — Local ACS + Receipt Demo (Offline)</h1>
    <p class="muted">Runs entirely in the browser. No network. Use this to show a real <em>Aim Coherence Score</em> and a signed receipt frame (with PQC signature placeholder) you can <strong>download as JSON</strong>.</p>

    <div class="card">
      <div class="row">
        <div>
          <label for="purity">Purity (no contradiction) — range [0…1]</label>
          <input id="purity" type="number" step="0.0001" min="0" max="1" value="1.0000" />
        </div>
        <div>
          <label for="drift">Temporal drift — range [0…1]</label>
          <input id="drift" type="number" step="0.0001" min="0" max="1" value="0.0000" />
        </div>
        <div>
          <label for="lei">Ethical irreversibility (LEI)</label>
          <input id="lei" type="number" step="1" min="0" max="1" value="1" />
        </div>
        <div>
          <label for="att">Secure attestation (trusted boot)</label>
          <select id="att">
            <option value="true" selected>trusted</option>
            <option value="false">untrusted</option>
          </select>
        </div>
        <div>
          <button class="btn" id="btnReset">Reset to Coherent</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div>
          <div class="muted">Aim Coherence Score</div>
          <div id="kpi" class="kpi ok">1.0000</div>
          <div id="status" class="pill good">STATUS: COHERENT</div>
          <span id="attPill" class="pill">ATTESTATION: TRUSTED</span>
        </div>
        <div>
          <button class="btn primary" id="btnReceipt">Generate Receipt</button>
        </div>
      </div>
      <p class="hint">ACS = Purity × (1 − Drift) × LEI (attestation is recorded separately and required for “green” status).</p>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="muted">Latest receipt (JSON)</div>
        <div>
          <button class="btn" id="btnCopy">Copy JSON</button>
          <button class="btn" id="btnSave">Download JSON</button>
        </div>
      </div>
      <pre id="out" class="mono">{}</pre>
    </div>
  </div>

  <script>
    // --- helpers -------------------------------------------------------------
    const $ = sel => document.querySelector(sel);

    function toHex(buffer) {
      const b = new Uint8Array(buffer);
      return Array.from(b).map(x => x.toString(16).padStart(2,'0')).join('');
    }

    // Stable stringify: sorts keys for canonical hashing
    function stableStringify(obj) {
      if (obj && typeof obj === 'object' && !Array.isArray(obj)) {
        const sorted = {};
        Object.keys(obj).sort().forEach(k => { sorted[k] = stableStringify(obj[k]); });
        return JSON.stringify(sorted, null, 2);
      } else if (Array.isArray(obj)) {
        return JSON.stringify(obj.map(stableStringify), null, 2);
      }
      return obj;
    }

    function round4(x){ return Math.round((+x + Number.EPSILON) * 10000) / 10000; }

    // Monotonic counter persisted locally
    function nextCounter() {
      const k = 'truthseal.counter';
      const n = parseInt(localStorage.getItem(k) || '0', 10) + 1;
      localStorage.setItem(k, String(n));
      return n;
    }

    // --- ACS calculation -----------------------------------------------------
    function calcACS(purity, drift, lei) {
      purity = Math.min(1, Math.max(0, +purity));
      drift  = Math.min(1, Math.max(0, +drift));
      lei    = (+lei === 1) ? 1 : 0;
      return round4(purity * (1 - drift) * lei);
    }

    async function sha256Hex(str) {
      const enc = new TextEncoder().encode(str);
      const digest = await crypto.subtle.digest('SHA-256', enc);
      return toHex(digest);
    }

    // --- UI wiring -----------------------------------------------------------
    const purity = $('#purity');
    const drift  = $('#drift');
    const lei    = $('#lei');
    const attSel = $('#att');
    const kpi    = $('#kpi');
    const status = $('#status');
    const attPill= $('#attPill');
    const out    = $('#out');

    function refresh() {
      const acs = calcACS(purity.value, drift.value, lei.value);
      kpi.textContent = acs.toFixed(4);
      const att = (attSel.value === 'true');
      kpi.className = 'kpi ' + ((acs === 1.0 && att) ? 'ok' : 'bad');
      status.textContent = 'STATUS: ' + ((acs === 1.0 && att) ? 'COHERENT' : 'QUARANTINE');
      status.className = 'pill ' + ((acs === 1.0 && att) ? 'good' : 'bad');
      attPill.textContent = 'ATTESTATION: ' + (att ? 'TRUSTED' : 'UNTRUSTED');
      attPill.className = 'pill ' + (att ? '' : 'bad');
    }

    purity.addEventListener('input', refresh);
    drift .addEventListener('input', refresh);
    lei   .addEventListener('input', refresh);
    attSel.addEventListener('change', refresh);

    $('#btnReset').addEventListener('click', () => {
      purity.value = '1.0000';
      drift.value  = '0.0000';
      lei.value    = '1';
      attSel.value = 'true';
      refresh();
    });

    // --- Receipt generation --------------------------------------------------
    let lastReceipt = {};

    async function generateReceipt() {
      const now = new Date().toISOString();
      const counter = nextCounter();
      const values = {
        purity: round4(purity.value),
        drift: round4(drift.value),
        lei: (+lei.value === 1) ? 1 : 0,
        attested: (attSel.value === 'true')
      };
      const acs = calcACS(values.purity, values.drift, values.lei);

      // Canonical body (what we attest & hash)
      const body = {
        acs,
        values,
        timestamp_utc: now,
        monotonic_counter: counter
      };
      const canon = stableStringify(body);
      const hash_hex = await sha256Hex(canon);

      // PQC placeholder — to be replaced by real ML-DSA/Dilithium signing later
      const pqc_signature = "PQC_SIGNATURE_PLACEHOLDER";

      lastReceipt = {
        receipt_version: "v1.0",
        body,
        hash_sha256: hash_hex,
        pqc_signature,
        note: "Local demo: structural frame only. Replace signature with PQC key once available."
      };
      out.textContent = JSON.stringify(lastReceipt, null, 2);
    }

    $('#btnReceipt').addEventListener('click', generateReceipt);

    $('#btnCopy').addEventListener('click', async () => {
      if (!out.textContent.trim()) await generateReceipt();
      await navigator.clipboard.writeText(out.textContent);
      alert('Receipt JSON copied to clipboard.');
    });

    $('#btnSave').addEventListener('click', async () => {
      if (!out.textContent.trim()) await generateReceipt();
      const blob = new Blob([out.textContent], { type: 'application/json' });
      const a = document.createElement('a');
      const ts = new Date().toISOString().replace(/[:.]/g,'-');
      a.href = URL.createObjectURL(blob);
      a.download = `truthseal-receipt-${ts}.json`;
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(a.href);
      a.remove();
    });

    // init
    refresh();
  </script>
</body>
</html>
