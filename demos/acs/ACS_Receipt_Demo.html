<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TruthSeal — Local ACS + Receipt Demo (Offline, v1.2)</title>
<style>
  :root { color-scheme: dark; }
  body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:#0b0f14; color:#e5eef7; }
  .wrap { max-width: 920px; margin: 28px auto; padding: 0 16px; }
  h1 { font-size: 22px; margin: 0 0 12px; color:#b9e6ff; }
  .muted { color:#8aa9c1; font-size:13px; }
  .card { background:#101826; border:1px solid #1f2a3a; border-radius:12px; padding:16px; margin:18px 0; }
  label { display:block; font-size:13px; color:#9fb6c9; margin:12px 0 6px; }
  input[type="number"], select { width:170px; padding:8px 10px; border-radius:8px; background:#0f1623; border:1px solid #253348; color:#dfe9f3; }
  .row{ display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
  .kpi{ font-size:46px; font-weight:900; letter-spacing:1px; }
  .ok{ color:#7ef7a3; } .bad{ color:#ffbb3b; }
  .btn{ cursor:pointer; padding:11px 16px; border-radius:10px; border:1px solid #2b3b52; background:#0f1a2a; color:#e5eef7; font-weight:700; pointer-events:auto; }
  .btn.primary{ background:#0b3d91; border-color:#0b3d91; }
  .pill{ display:inline-block; padding:5px 10px; border-radius:999px; font-size:12px; font-weight:700; margin-right:6px; }
  .pill.good{ background:rgba(62,207,142,.18); border:1px solid rgba(62,207,142,.35); color:#82f7b5; }
  .pill.bad{  background:rgba(255,183,59,.12); border:1px solid rgba(255,183,59,.35); color:#ffcc6a; }
  pre{ background:#0c1522; border:1px solid #223149; border-radius:10px; padding:12px; overflow:auto; }
  .hint{ font-size:12px; color:#8aa9c1; }
</style>
</head>
<body>
  <div class="wrap">
    <h1>TruthSeal — Local ACS + Receipt Demo (Offline)</h1>
    <p class="muted">Runs entirely in the browser. No network. Use this to show a real Aim Coherence Score and then save a receipt JSON locally.</p>

    <div class="card">
      <label>Purity (no contradiction) — range [0…1]</label>
      <input id="purity" type="number" step="0.0001" min="0" max="1" value="1.0000" oninput="updateACS()" onchange="updateACS()"/>

      <label>Temporal drift — range [0…1]</label>
      <input id="drift" type="number" step="0.0001" min="0" max="1" value="0.0000" oninput="updateACS()" onchange="updateACS()"/>

      <label>Ethical irreversibility (LEI)</label>
      <input id="lei" type="number" step="1" min="0" max="1" value="1" oninput="updateACS()" onchange="updateACS()"/>

      <label>Secure attestation (trusted boot)</label>
      <select id="attn" onchange="updateACS()">
        <option value="trusted" selected>trusted</option>
        <option value="untrusted">untrusted</option>
      </select>

      <div style="margin-top:14px">
        <button type="button" class="btn" onclick="resetToCoherent()">Reset to Coherent</button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div id="acsVal" class="kpi ok">1.0000</div>
          <div>
            <span id="statusPill" class="pill good">STATUS: COHERENT</span>
            <span id="attnPill" class="pill good">ATTESTATION: TRUSTED</span>
          </div>
        </div>
        <div><p class="hint">ACS = Purity × (1 − Drift) × LEI</p></div>
      </div>

      <div class="row" style="margin-top:14px">
        <button type="button" class="btn primary" onclick="generateReceipt()">Generate Receipt</button>
        <button type="button" class="btn" onclick="downloadJSON()">Download JSON</button>
        <button type="button" class="btn" onclick="showJSON()">Show JSON</button>
      </div>
      <p class="hint" style="margin-top:10px">If download is blocked on iPhone, tap “Show JSON”, then long-press to copy.</p>
      <div id="jsonBox" style="display:none; margin-top:12px">
        <pre id="jsonOut"></pre>
      </div>
    </div>
  </div>

<script>
  // --- Global state (Quick Look–safe) ---
  let LAST_RECEIPT = null;

  function clamp01(x){ x = Number(x||0); if (isNaN(x)) x = 0; return Math.max(0, Math.min(1, x)); }
  function fmt4(x){ return Number(x).toFixed(4); }
  function nowISO(){ return new Date().toISOString(); }
  function nextCounter(){
    try{
      const k='ts_monotonic_counter';
      const n = Number(localStorage.getItem(k) || '0') + 1;
      localStorage.setItem(k, String(n));
      return n;
    }catch(e){ return 1; }
  }

  function readInputs(){
    return {
      purity: clamp01(document.getElementById('purity').value),
      drift:  clamp01(document.getElementById('drift').value),
      lei:    Number(document.getElementById('lei').value) === 1 ? 1 : 0,
      attn:   document.getElementById('attn').value
    };
  }

  function computeACS(p, d, l){ return p * (1 - d) * l; }

  function paintACS(acs, attn){
    const kpi = document.getElementById('acsVal');
    const st  = document.getElementById('statusPill');
    const ap  = document.getElementById('attnPill');
    const coherent = (acs === 1.0);
    kpi.textContent = fmt4(acs);
    kpi.className = 'kpi ' + (coherent && attn==='trusted' ? 'ok' : 'bad');
    st.textContent = coherent ? 'STATUS: COHERENT' : 'STATUS: DECOHERENCE';
    st.className   = 'pill ' + (coherent ? 'good' : 'bad');
    ap.textContent = attn==='trusted' ? 'ATTESTATION: TRUSTED' : 'ATTESTATION: UNTRUSTED';
    ap.className   = 'pill ' + (attn==='trusted' ? 'good' : 'bad');
  }

  function updateACS(){
    const {purity, drift, lei, attn} = readInputs();
    const acs = Number(computeACS(purity, drift, lei).toFixed(4));
    paintACS(acs, attn);
  }

  function resetToCoherent(){
    document.getElementById('purity').value = '1.0000';
    document.getElementById('drift').value  = '0.0000';
    document.getElementById('lei').value    = '1';
    document.getElementById('attn').value   = 'trusted';
    updateACS();
  }

  function buildReceipt(){
    const {purity, drift, lei, attn} = readInputs();
    const acsRaw = computeACS(purity, drift, lei);
    const receipt = {
      id: 'ts_'+Date.now().toString(36),
      created_utc: nowISO(),
      monotonic_counter: nextCounter(),
      attestation: attn,                       // trusted | untrusted
      inputs: { purity, drift, lei },
      acs: Number(acsRaw.toFixed(4)),
      pqc_signature: "PQC_SIGNATURE_PLACEHOLDER",
      note: "Local offline demo (no network)."
    };
    return receipt;
  }

  function generateReceipt(){
    LAST_RECEIPT = buildReceipt();
    document.getElementById('jsonOut').textContent = JSON.stringify(LAST_RECEIPT, null, 2);
    document.getElementById('jsonBox').style.display = 'block';
    updateACS();
  }

  function downloadJSON(){
    if(!LAST_RECEIPT) LAST_RECEIPT = buildReceipt();
    const blob = new Blob([JSON.stringify(LAST_RECEIPT, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const ts = new Date().toISOString().replace(/[-:TZ.]/g,'').slice(0,14);
    a.download = `truthseal-receipt-acs_${ts}.json`;
    document.body.appendChild(a);
    a.click(); // iOS: works when invoked from onclick
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 120);
  }

  function showJSON(){
    if(!LAST_RECEIPT) LAST_RECEIPT = buildReceipt();
    document.getElementById('jsonOut').textContent = JSON.stringify(LAST_RECEIPT, null, 2);
    document.getElementById('jsonBox').style.display = 'block';
  }

  // First paint
  updateACS();
</script>
</body>
</html>
