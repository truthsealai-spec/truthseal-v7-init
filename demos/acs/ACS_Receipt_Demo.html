<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TruthSeal — Local ACS + Receipt Demo (Offline, v1.4)</title>
<style>
  :root{color-scheme:dark}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b0f14;color:#e6eef7}
  .wrap{max-width:920px;margin:28px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 12px}
  .muted{color:#9ab;font-size:13px}
  .card{background:#101820;border:1px solid #223344;border-radius:14px;padding:16px;margin:14px 0}
  label{display:block;font-size:13px;color:#9ab;margin:8px 0 4px}
  input[type="number"],select{width:170px;padding:8px 10px;border-radius:10px;border:1px solid #2a3b4f;background:#0f151c;color:#fff}
  .row{display:flex;flex-wrap:wrap;gap:14px 24px;align-items:flex-end}
  .pill{display:inline-block;padding:5px 10px;border-radius:999px;background:#0f2432;border:1px solid #234;font-size:12px;color:#cfe7ff;margin-right:8px}
  .pill.good{background:#0a2a1a;border-color:#1e4;color:#bfffd1}
  .pill.bad{background:#2a0a0a;border-color:#e44;color:#ffc9c9}
  .btn{cursor:pointer;padding:11px 16px;border-radius:12px;border:1px solid #2b3b52;background:#0f1a2a;color:#e6eef7;font-weight:700}
  .btn.primary{background:#0b3d91}
  pre{background:#0c131a;border:1px solid #1f2d3a;border-radius:12px;padding:12px;overflow:auto;font-size:12px}
  .kpi{font-size:44px;font-weight:800;letter-spacing:-0.02em}
  .ok{color:#86f7a6}.bad{color:#ffb3b3}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
  .hint{font-size:12px;color:#9ab}
</style>
</head>
<body>
<div class="wrap">
  <h1>TruthSeal — Local ACS + Receipt Demo (Offline)</h1>
  <p class="muted">Runs entirely in the browser. No network. Show a real <em>Aim Coherence Score</em> and save a receipt JSON locally.</p>

  <!-- Controls -->
  <div class="card">
    <div class="row">
      <div>
        <label for="purity">Purity (no contradiction) — range [0…1]</label>
        <input id="purity" type="number" step="0.0001" min="0" max="1" value="1.0000" oninput="refresh()"/>
      </div>
      <div>
        <label for="drift">Temporal drift — range [0…1]</label>
        <input id="drift" type="number" step="0.0001" min="0" max="1" value="0.0000" oninput="refresh()"/>
      </div>
      <div>
        <label for="lei">Ethical irreversibility (LEI)</label>
        <input id="lei" type="number" step="1" min="0" max="1" value="1" oninput="refresh()"/>
      </div>
      <div>
        <label for="att">Secure attestation (trusted boot)</label>
        <select id="att" onchange="refresh()">
          <option value="true" selected>trusted</option>
          <option value="false">untrusted</option>
        </select>
      </div>
      <div>
        <button class="btn" type="button" onclick="resetToCoherent()">Reset to Coherent</button>
      </div>
    </div>
  </div>

  <!-- KPI + Generate -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div>
        <div class="muted">Aim Coherence Score</div>
        <div id="kpi" class="kpi ok">1.0000</div>
        <div id="status" class="pill good">STATUS: COHERENT</div>
        <span id="attPill" class="pill">ATTESTATION: TRUSTED</span>
      </div>
      <div>
        <button class="btn primary" type="button" onclick="generateReceipt()">Generate Receipt</button>
      </div>
    </div>
    <p class="hint">ACS = Purity × (1 − Drift) × LEI (attestation recorded separately and required for “green” status).</p>
  </div>

  <!-- Output / Actions -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="muted">Latest receipt (JSON)</div>
      <div>
        <button class="btn" type="button" onclick="copyJSON()">Copy JSON</button>
        <button class="btn" type="button" onclick="saveJSON()">Download JSON</button>
        <button class="btn" type="button" onclick="showJSON()">Show JSON</button>
      </div>
    </div>
    <pre id="out" class="mono" tabindex="0">{}</pre>
  </div>
</div>

<script>
  /* === helpers === */
  const $ = s => document.querySelector(s);
  const round4 = x => Math.round((+x + Number.EPSILON)*10000)/10000;

  function nextCounter(){
    try{ const k='truthseal.counter';
      const n = parseInt(localStorage.getItem(k)||'0',10)+1;
      localStorage.setItem(k,String(n)); return n;
    }catch(_){ return 1; }
  }

  function calcACS(purity,drift,lei){
    purity = Math.min(1,Math.max(0,+purity));
    drift  = Math.min(1,Math.max(0,+drift));
    lei    = (+lei===1)?1:0;
    return round4(purity*(1-drift)*lei);
  }

  function stableStringify(o){ return JSON.stringify(o,Object.keys(o).sort(),2); }
  async function sha256Hex(str){
    const enc = new TextEncoder().encode(str);
    const dg = await crypto.subtle.digest('SHA-256',enc);
    return Array.from(new Uint8Array(dg)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  /* === UI refs === */
  const purity=$('#purity'), drift=$('#drift'), lei=$('#lei'), attSel=$('#att');
  const kpi=$('#kpi'), status=$('#status'), attPill=$('#attPill'), out=$('#out');

  function refresh(){
    const acs = calcACS(purity.value,drift.value,lei.value);
    const att = (attSel.value==='true');
    kpi.textContent = acs.toFixed(4);
    kpi.className = 'kpi ' + ((acs===1.0&&att)?'ok':'bad');
    status.textContent = 'STATUS: ' + ((acs===1.0&&att)?'COHERENT':'QUARANTINE');
    status.className = 'pill ' + ((acs===1.0&&att)?'good':'bad');
    attPill.textContent = 'ATTESTATION: ' + (att?'TRUSTED':'UNTRUSTED');
    attPill.className = 'pill ' + (att?'':'bad');
  }

  function resetToCoherent(){
    purity.value='1.0000'; drift.value='0.0000'; lei.value='1'; attSel.value='true';
    refresh();
  }

  let lastReceipt = {};
  async function generateReceipt(){
    const now = new Date().toISOString();
    const counter = nextCounter();
    const values = {
      purity: round4(purity.value),
      drift : round4(drift.value),
      lei   : (+lei.value===1)?1:0,
      attested: (attSel.value==='true')
    };
    const acs = calcACS(values.purity,values.drift,values.lei);
    const body = { acs, values, timestamp_utc: now, monotonic_counter: counter };
    const canon = stableStringify(body);
    const hash_hex = await sha256Hex(canon);
    const pqc_signature = "PQC_SIGNATURE_PLACEHOLDER";
    lastReceipt = { receipt_version:"v1.0", body, hash_sha256:hash_hex, pqc_signature,
      note:"Local demo: frame only. Replace signature with PQC key once available." };
    out.textContent = JSON.stringify(lastReceipt,null,2);
    showJSON();
  }

  async function copyJSON(){
    const text = out.textContent.trim() ? out.textContent : (await (generateReceipt(), out.textContent));
    try{
      await navigator.clipboard.writeText(text);
      alert('Receipt JSON copied.');
    }catch(_){
      // Fallback for iOS Quick Look: select the text so user can long-press → Copy
      const range = document.createRange(); range.selectNodeContents(out);
      const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
      out.focus();
      alert('Selected JSON. Long-press → Copy.');
    }
  }

  async function saveJSON(){
    if(!out.textContent.trim()) await generateReceipt();
    try{
      const blob = new Blob([out.textContent],{type:'application/json'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=`truthseal-receipt-${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},120);
    }catch(_){
      // Quick Look fallback: just reveal JSON to let user Share → Save
      showJSON();
      alert('If download is blocked here, use Share → Save or long-press to copy.');
    }
  }

  function showJSON(){ out.scrollIntoView({behavior:'smooth',block:'start'}); }

  // first paint
  refresh();
</script>
</body>
</html>
