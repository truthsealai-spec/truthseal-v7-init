<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TruthSeal — Local ACS + Receipt Demo</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    .wrap { max-width: 980px; margin: 28px auto; padding: 0 16px; }
    h1 { font-size: 28px; margin: 0 0 6px 0; }
    .v { display:inline-block; font-size:12px; background:#20313a; border-radius:12px; padding:2px 8px; margin-left:8px; }
    .muted { color:#9ab; font-size:13px; line-height:1.4; margin: 10px 0 22px 0; }
    .card { background:#101820; border:1px solid #1a2a33; border-radius:14px; padding:18px; margin:18px 0; }
    label { display:block; font-size:13px; color:#9fbdc9; margin:14px 0 8px 0; }
    input, select, button { font: inherit; }
    input[type="text"], select {
      width:100%; padding:12px 14px; border-radius:10px; border:1px solid #233641; background:#0b141b;
      color:#cfe5ef; outline: none; -webkit-appearance:none; appearance:none;
    }
    .row { display:flex; gap:14px; flex-wrap:wrap; align-items:center; }
    .pill { display:inline-block; padding:6px 12px; border-radius:999px; background:#0b2330; border:1px solid #214253; font-weight:600; }
    .ok { background:#0c2f22; border-color:#124d3a; color:#9ff3c0; }
    .warn { background:#2a1e1e; border-color:#5a2f2f; color:#ffc8bd; }
    .kpi { font-size:56px; font-weight:800; letter-spacing:1px; margin:6px 0; }
    .btn { cursor:pointer; padding:12px 18px; border-radius:12px; border:1px solid #213e4c; background:#0b3d91; color:white; font-weight:700; }
    .btn:active { transform: translateY(1px); }
    .btn.alt { background:#0b2130; }
    .btn.ghost { background:transparent; border-color:#2b4d5f; }
    pre { background:#0b1320; border:1px solid #1b2c3a; border-radius:12px; padding:14px; overflow:auto; color:#bfe4ff; }
    .hint { font-size:12px; color:#9ab; margin-top:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>TruthSeal — Local ACS + Receipt Demo <span class="v">v1.6</span></h1>
    <p class="muted">Runs entirely on-device (no network). Show a real <em>Aim Coherence Score</em> and save a receipt JSON locally.</p>

    <div class="card">
      <label for="purity">Purity (no contradiction) — range [0…1]</label>
      <input id="purity" type="text" inputmode="decimal" placeholder="1.0" value="1.0" />

      <label for="drift">Temporal drift — range [0…1]</label>
      <input id="drift" type="text" inputmode="decimal" placeholder="0.0" value="0.0" />

      <label for="lei">Ethical irreversibility (LEI)</label>
      <input id="lei" type="text" inputmode="decimal" placeholder="1" value="1" />

      <label for="att">Secure attestation (trusted boot)</label>
      <select id="att">
        <option value="trusted" selected>trusted</option>
        <option value="untrusted">untrusted</option>
      </select>

      <div style="margin-top:14px;">
        <button id="resetBtn" class="btn ghost">Reset to Coherent</button>
      </div>
    </div>

    <div class="card" id="scoreCard">
      <div class="kpi" id="kpi">1.0000</div>
      <div class="row">
        <div class="pill ok" id="statusPill">STATUS: COHERENT</div>
        <div class="pill ok" id="attPill">ATTESTATION: TRUSTED</div>
      </div>
      <p class="muted">ACS = Purity × (1 − Drift) × LEI (attestation recorded separately and required for “green” status).</p>
      <button id="genBtn" class="btn">Generate Receipt</button>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0;">Latest receipt (JSON)</h3>
      <div class="row" style="margin: 8px 0 10px 0;">
        <button id="copyBtn" class="btn alt">Copy JSON</button>
        <button id="dlBtn" class="btn alt">Download JSON</button>
        <button id="showBtn" class="btn alt">Show JSON</button>
      </div>
      <pre id="out">{}</pre>
      <p class="hint">If download is blocked on iPhone, tap “Show JSON”, then long-press to copy.</p>
    </div>
  </div>

  <script>
    // -------- helpers
    const $ = (id) => document.getElementById(id);
    function clamp01(x) { x = Number(x); return isFinite(x) ? Math.min(1, Math.max(0, x)) : 0; }
    function fmt4(n){ return (Math.round(n*10000)/10000).toFixed(4); }

    async function sha256Hex(s){
      try{
        const enc = new TextEncoder().encode(s);
        const buf = await crypto.subtle.digest('SHA-256', enc);
        return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
      }catch{
        // minimal fallback
        return Array.from(s).reduce((h,c)=>((h<<5)-h)+c.charCodeAt(0),0>>>0).toString(16);
      }
    }

    function score(){
      const P = clamp01(purity.value);
      const D = clamp01(drift.value);
      const L = clamp01(lei.value);
      const val = P * (1 - D) * L;
      kpi.textContent = fmt4(val);
      statusPill.className = 'pill ' + (val >= 1 ? 'ok' : 'warn');
      statusPill.textContent = 'STATUS: ' + (val >= 1 ? 'COHERENT' : 'INCOHERENT');
      const trusted = (att.value === 'trusted');
      attPill.className = 'pill ' + (trusted ? 'ok' : 'warn');
      attPill.textContent = 'ATTESTATION: ' + (trusted ? 'TRUSTED' : 'UNTRUSTED');
      return val;
    }

    function nowIso(){ return new Date().toISOString(); }
    function monotonic() {
      const k = 'ts_monotonic_counter';
      const v = Number(localStorage.getItem(k) || '0') + 1;
      localStorage.setItem(k, String(v));
      return v;
    }

    async function generate(){
      const acs = score();
      const frame = {
        version: '1.0',
        when_utc: nowIso(),
        counter: monotonic(),
        inputs: {
          purity: clamp01(purity.value),
          drift: clamp01(drift.value),
          lei: clamp01(lei.value),
          attestation: att.value
        },
        acs: Number(acs.toFixed(6)),
        pqc_signature: 'placeholder',    // PQC slot (e.g., Dilithium) for hardware path
      };
      frame.digest_sha256 = await sha256Hex(JSON.stringify(frame));
      out.textContent = JSON.stringify(frame, null, 2);
      return frame;
    }

    function dl(filename, text){
      const a = document.createElement('a');
      a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(text);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    async function copy(text){
      try{
        await navigator.clipboard.writeText(text);
        alert('JSON copied to clipboard');
      }catch{
        // Fallback for iOS Quick Look
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); ta.remove();
        alert('JSON copied (fallback)');
      }
    }

    // -------- bind
    const purity = $('purity'), drift = $('drift'), lei = $('lei'), att = $('att');
    const kpi = $('kpi'), statusPill = $('statusPill'), attPill = $('attPill'), out = $('out');

    // Update score on input
    [purity, drift, lei, att].forEach(el => {
      el.addEventListener('input', score, { passive: true });
      el.addEventListener('change', score, { passive: true });
    });

    function bindTap(id, fn){
      const el = $(id);
      // handle both tap and click so iOS Quick Look can’t swallow it
      el.addEventListener('touchend', (e)=>{ e.preventDefault(); fn(); }, { passive:false });
      el.addEventListener('click', (e)=>{ e.preventDefault(); fn(); });
    }

    bindTap('resetBtn', () => { purity.value='1'; drift.value='0'; lei.value='1'; att.value='trusted'; score(); });
    bindTap('genBtn', async () => { const f = await generate(); try{ navigator.vibrate && navigator.vibrate(10);}catch{} });
    bindTap('copyBtn', async () => copy(out.textContent));
    bindTap('dlBtn', async () => dl('truthseal_acs_receipt.json', out.textContent));
    bindTap('showBtn', () => { out.scrollIntoView({behavior:'smooth', block:'center'}); });

    // initial compute
    score();
  </script>
</body>
</html>
