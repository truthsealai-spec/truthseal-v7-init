name: ACS PR Gate

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'governance/**'
      - 'docs/**'
      - '.github/workflows/acs_pr_gate.yml'

permissions:
  contents: read

jobs:
  gate:
    runs-on: ubuntu-latest
    env:
      HARD_GATE: 'true'        # set to 'false' to warn-only
      PURITY_MIN: '0.80'
      SELFREG_MIN: '0.60'
      DRIFT_MAX: '0.30'
      ACS_MIN: '0.70'
      METRICS_FILE: governance/guards/observability/metrics_sample.json
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure jq/bc
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
          if ! command -v bc >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y bc
          fi

      - name: Read ACS sample
        id: read
        run: |
          if [ ! -f "$METRICS_FILE" ]; then
            echo "file_missing=true" >> "$GITHUB_OUTPUT"
            echo "WARN_ONLY=yes" >> "$GITHUB_ENV"
            exit 0
          fi
          P=$(jq -r '.purity'  "$METRICS_FILE")
          S=$(jq -r '.selfreg' "$METRICS_FILE")
          D=$(jq -r '.drift'   "$METRICS_FILE")
          A=$(jq -r '.acs'     "$METRICS_FILE")
          echo "purity=$P"  >> "$GITHUB_OUTPUT"
          echo "selfreg=$S" >> "$GITHUB_OUTPUT"
          echo "drift=$D"   >> "$GITHUB_OUTPUT"
          echo "acs=$A"     >> "$GITHUB_OUTPUT"

      - name: Gate decision
        run: |
          if [ "${WARN_ONLY:-no}" = "yes" ]; then
            echo "::warning::No metrics file found. Skipping hard gate."
            exit 0
          fi
          P="${{ steps.read.outputs.purity }}"
          S="${{ steps.read.outputs.selfreg }}"
          D="${{ steps.read.outputs.drift }}"
          A="${{ steps.read.outputs.acs }}"

          FAIL=0
          [ "$(echo "$P < $PURITY_MIN"  | bc -l)" -eq 1 ] && echo "::error::Purity $P < $PURITY_MIN"   && FAIL=1
          [ "$(echo "$S < $SELFREG_MIN" | bc -l)" -eq 1 ] && echo "::error::SelfReg $S < $SELFREG_MIN" && FAIL=1
          [ "$(echo "$D > $DRIFT_MAX"   | bc -l)" -eq 1 ] && echo "::error::Drift $D > $DRIFT_MAX"     && FAIL=1
          [ "$(echo "$A < $ACS_MIN"     | bc -l)" -eq 1 ] && echo "::error::ACS $A < $ACS_MIN"         && FAIL=1

          if [ "$HARD_GATE" = "true" ] && [ $FAIL -eq 1 ]; then
            echo "Hard gate enforced."; exit 1
          fi
          echo "Gate OK."
