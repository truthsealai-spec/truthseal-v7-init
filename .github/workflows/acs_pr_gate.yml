name: ACS PR Gate
on:
  pull_request:
    branches: [ main ]
    paths:
      - 'governance/**'
      - 'docs/**'
      - '.github/workflows/acs_pr_gate.yml'

jobs:
  gate:
    runs-on: ubuntu-latest
    env:
      HARD_GATE: 'true'     # set to 'false' to warn-only
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Load thresholds
        run: |
          echo "PURITY_MIN=0.80" >> $GITHUB_ENV
          echo "SELFREG_MIN=0.60" >> $GITHUB_ENV
          echo "DRIFT_MAX=0.30"  >> $GITHUB_ENV
          echo "ACS_MIN=0.70"    >> $GITHUB_ENV

      - name: Read ACS sample
        run: |
          FILE="governance/guards/observability/metrics_sample.json"
          if [ ! -f "$FILE" ]; then
            echo "::warning::No metrics_sample.json found; passing in warn-only mode."
            echo "WARN_ONLY=yes" >> $GITHUB_ENV
          else
            PURITY=$(jq -r '.purity' "$FILE")
            SELFREG=$(jq -r '.selfreg' "$FILE")
            DRIFT=$(jq -r '.drift' "$FILE")
            ACS=$(jq -r '.acs' "$FILE")
            echo "PURITY=$PURITY  SELFREG=$SELFREG  DRIFT=$DRIFT  ACS=$ACS"
            echo "PURITY_OK=$([ "$(echo "$PURITY>=$PURITY_MIN" | bc -l)" = 1 ] && echo ok || echo fail)" >> $GITHUB_ENV
            echo "SELFREG_OK=$([ "$(echo "$SELFREG>=$SELFREG_MIN" | bc -l)" = 1 ] && echo ok || echo fail)" >> $GITHUB_ENV
            echo "DRIFT_OK=$([ "$(echo "$DRIFT<=$DRIFT_MAX" | bc -l)" = 1 ] && echo ok || echo fail)" >> $GITHUB_ENV
            echo "ACS_OK=$([ "$(echo "$ACS>=$ACS_MIN" | bc -l)" = 1 ] && echo ok || echo fail)" >> $GITHUB_ENV
          fi

      - name: Gate decision
        run: |
          if [ "${WARN_ONLY}" = "yes" ]; then
            echo "No metrics file; warning only."
            exit 0
          fi
          echo "Results: PURITY=$PURITY_OK SELFREG=$SELFREG_OK DRIFT=$DRIFT_OK ACS=$ACS_OK"
          if [ "$HARD_GATE" = "true" ] && { [ "$PURITY_OK" != "ok" ] || [ "$SELFREG_OK" != "ok" ] || [ "$DRIFT_OK" != "ok" ] || [ "$ACS_OK" != "ok" ]; }; then
            echo "::error::ACS thresholds not met (hard gate)."
            exit 1
          fi
          echo "Gate passed (or warn-only)."
