name: TruthSeal PR Gate (ACS thresholds)

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'governance/guards/observability/**'
      - '.github/workflows/acs_pr_gate.yml'

permissions:
  contents: read

jobs:
  gate:
    runs-on: ubuntu-latest
    env:
      HARD_GATE: 'true'
      THRESH_PURITY: '0.80'
      THRESH_SELFREG: '0.60'
      THRESH_DRIFT: '0.30'   # max allowed
      THRESH_ACS: '0.70'
      METRICS_FILE: 'governance/guards/observability/metrics_sample.json'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show metrics input
        run: |
          echo "Using $METRICS_FILE"
          if [ -f "$METRICS_FILE" ]; then cat "$METRICS_FILE"; else echo "{}"; fi

      - name: Gate check
        run: |
          python - << 'PY'
          import json, os, sys
          path = os.environ.get("METRICS_FILE","")
          try:
              with open(path, "r", encoding="utf-8") as f:
                  data = json.load(f)
          except Exception as e:
              print(f"::error::failed to load metrics file {path}: {e}")
              sys.exit(1)

          purity  = float(data.get("Purity",  data.get("purity", 0)))
          selfreg = float(data.get("SelfReg", data.get("selfReg", 0)))
          drift   = float(data.get("Drift",   data.get("drift", 1)))
          acs     = float(data.get("ACS",     data.get("acs", 0)))

          thr_p = float(os.environ.get("THRESH_PURITY",   "0.80"))
          thr_s = float(os.environ.get("THRESH_SELFREG",  "0.60"))
          thr_d = float(os.environ.get("THRESH_DRIFT",    "0.30"))
          thr_a = float(os.environ.get("THRESH_ACS",      "0.70"))
          hard  = os.environ.get("HARD_GATE","false").lower()=="true"

          print(f"Purity={purity} (>= {thr_p})")
          print(f"SelfReg={selfreg} (>= {thr_s})")
          print(f"Drift={drift} (<= {thr_d})")
          print(f"ACS={acs} (>= {thr_a})")

          bad=[]
          if purity  < thr_p: bad.append("Purity")
          if selfreg < thr_s: bad.append("SelfReg")
          if drift   > thr_d: bad.append("Drift")
          if acs     < thr_a: bad.append("ACS")

          if bad and hard:
              print(f"::error::Thresholds not met: {', '.join(bad)}")
              sys.exit(2)
          PY

      - name: Summary
        if: always()
        run: echo "ACS PR Gate completed." >> "$GITHUB_STEP_SUMMARY"
