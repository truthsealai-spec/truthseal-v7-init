name: OTS Receipt Reminder (4pm Melbourne)

on:
  schedule:
    - cron: "0 5 * * *"   # 16:00 AEDT == 05:00 UTC
  workflow_dispatch:      # you can run it manually any time

permissions:
  contents: read
  issues: write

jobs:
  check-ots:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for OTS receipt
        id: check
        run: |
          FILE="governance/ledger/receipts/attestation_packet_v7.1.sha256.txt.ots"
          if [ -f "$FILE" ]; then
            echo "found=true" >> "$GITHUB_OUTPUT"
            echo "OTS receipt found: $FILE"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
            echo "OTS receipt NOT found."
          fi

      - name: Open (or update) reminder issue if missing
        if: steps.check.outputs.found == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const title = "Reminder: Verify & Upload OTS for attestation_packet_v7.1.sha256.txt";
            const body  = [
              "It's 16:00 AEDT. Please verify the OpenTimestamps receipt at <https://opentimestamps.org> ",
              "and upload the `.ots` to:",
              "`governance/ledger/receipts/attestation_packet_v7.1.sha256.txt.ots`",
              "",
              "Commit message suggestion:",
              "`OTS completed – block #<height> (v7.1)`"
            ].join("\n");

            // Find an open reminder issue (label: reminder, ots)
            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              { owner, repo, state: "open", labels: "reminder,ots" }
            );
            const existing = issues.find(i => i.title === title);

            if (existing) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: existing.number,
                body: "Daily ping — OTS still missing."
              });
            } else {
              await github.rest.issues.create({
                owner, repo, title, body,
                labels: ["reminder","ots"]
              });
            }

      - name: Close reminder if OTS exists
        if: steps.check.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              { owner, repo, state: "open", labels: "reminder,ots" }
            );
            for (const issue of issues) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: issue.number,
                body: "OTS receipt present — closing reminder."
              });
              await github.rest.issues.update({
                owner, repo, issue_number: issue.number, state: "closed"
              });
            }
